functionality needed
	fast loading time
	low memory footprint
	offline notes
	compressed audio
	checkboxes
	folder tracking
	snapshot sizing
	search
		EN has its own search facility
			only available online
		specifications are available
			so it could be implemented offline also
		sorting
original main screen buttons
	text note
	ink note
	snapshot
	audio note
	upload file
tech needed
	UI
		HTMLayout
	DTD checking
		only needed for testing
	THTTP
	ENML XML->HTML convertion
		TinyXML
		pugixml
		RapidXML
need to figure out the overall design
	highest level features
		view notes
			subsets of notes
			with sorting
		create notes
			text at first
			photo, ink, audio, files later
		modify todo notes
			by checking/unchecking
		find notes
		switch notebooks
		sync
	required functionality
		UI to view a set of notes
		UI to view a note
		UI to choose a method of note creation
		note creation UI
		note storage and retrieval
		note synchronization
	runtime design
		load main UI first
		delay-load the remaining functionality
		nah, not until profiling shows it to be a bottleneck
	UI design
		log in
			get username and password
			go to the main screen
			action
				OK/Cancel
		main screen
			create notes
			action
				Notes
			menu
				About
				Logout
				Exit
		notes view
			shows most recent notes
			options
				search
				sort
					HTMLayoutSortElements
				reset
			actions
				New note/Sync
		sync
			collapsible
			list sync events
				status
				progress
		soft keys
			neither the main screen nor notes view have main actions
			I could make a single screen
				with the following elements
					notes list
					new note popout
					synchronization indicator
					search box
					sort popout
			however, showing the new note screen is much faster
				more optimized for starting quickly
				less optimized for coninuous use
			how to place the elements
				search box at the top
				notes list has to take as much space as possible
				have to be on the bottom
				as buttons with text, like EN iPhone
					Create Note
					Sort by <order>
					Sync
				bad idea
				make Sync the default action
				make note creation a fake first note
				make sort/filter menu options
		new screens
			sign in
				username/password and link to evernote.com
				soft keys
					Sign in
					Cancel
			notes list
				notes list, search, creation
				soft keys
					Sync
					Menu
						Sign out
						Notebook
						About
						Exit
			note view
				note contents, prev/next navigation
				soft keys
					Notes
			note creation
				soft keys
					OK
					Cancel
			about
				branding, version, author, date
				soft keys
					OK
	data storage design
		store notes and settings
		EN has a flat data model
		so, we can make tables directly from structs
		unsynced notes
			should be stored with the rest
			but marked as asynced
		at sync
			query the database for unsynced notes
			replace them with synced ones received from the server
		full-text search
			provided by the FTS3 extension of SQLite
			used by the Windows EN client
	synchronization design
		sync is comprised of several tasks
			download new server notes
				getSyncState/getSyncChunk/getNoteContent/getResourceData
				resolve conflicts
			upload new local notes
				the server provides replacements for the local notes
				resolve conflicts
		sync connections
			USB always
			9G never
			WiFi probably
		manual sync
			needed for searching server notes
			uploading local notes
			either way, it is only needed in the notes screen
		fault tolerance
			downloading notes
				via SQLite transactions
			uploading notes
				create a log before uploading
				clear it on success
				try to repeat on failure
		need to show the user when sync is required
			how many unsynced messages he has
			this calls for a button, instead of the soft key
				not really
				could add a number to the soft key title
	program structure
		MVP - Presenter First
			DB and registry are the model
			the windows are the views with controllers attached
		main window is not always needed
			not when there is no user signed in
		who desides which windows are created when?
			some sort of overlord state machine
			created at startup
			decides which windows to show
			receives messages from these windows
			changes window states
		there should be a flat stateless core
			with heavy-duty functions called by the controllers
	user credentials
		CryptProtectData/CryptUnprotectData
	EN connection
		through credentials verification
			get AuthenticationToken from EN
		through note sync
			upload/download notes and resources
program start
	sounds like an event
	when the program starts with a user, his notes are displayed
		and his credentials not authenticated
		meaning, that valid credentials are not needed
		the user is, then, separate from credentials
	there should be a user model, then, with credentials and notebooks
	when the program starts without a user, a default user is created
		with empty credentials
		which are, obviously, invalid
		and an empty notebook
	what should happen
		the last active user is retrieved from the registry
			default user assumed
		the user's database is loaded
			if no database is present
				create one
				with an empty default notebook
			if loading fails
				go to sign in with the error message
		the list of notes is retreived
			from the last active notebook
		the list of notes is displayed
NoteListView
	displays notes
		NoteListModel
	performs searches
		affects NoteListModel
		but indirectly
		since the search is within the current notebook
	lists notebooks
		UserModel
	displaying notes requires creation of HTML code and HTMLayout handling
		created from an internal format
		which should be as close to Evernote's as possible
		preferably, Evernote's format
			seems usable for internal representation
			better yet, create a note interface
			the real one will delegate to EN Note
				cache to allow access to members through interface
			the mock one will do something else
			nah, better convert on sync
		sounds like the problem in the paper
			they created an adapter that converted data
			but my problem is simpler
			merely one-way encoding
		streaming
			no need to encode all at once
			HTMLayout will need one DOM element at a time
				then, a mass update
	creation
		should be created before loading notes
			before the user is loaded
		so, the user should be loaded in responce to window being created
		create separate events for starting the UI and starting the model
			no, the app does not know when the window is created
			it should return to the message loop first
asynchronous start
	the model should not be loaded on the UI thread
	UI should be created first
		then the message loop should start running
		then the model should start loading on a separate thread
	everything is connected in advance
	so to start loading on another thread, a signal has to be made on another thread
asynchronous sync
	could be done using a worker thread
AppModel
	maybe, it is entirely redundant
	before the message loop starts
		everything needs to be connected
		and the main window needs to be created
	everything else should start in response to main window creation
		after the message loop starts running
	PostQuitMessage is a good way to terminate
lock hierarchy
	UI runs on its own thread
	UI also starts other threads
		loading data
		sync
	UI does not access other objects directly
		because it a view
	UI signals should not block
		because they return nothing
		however, they do signal user intent
		which might warrant some immediate UI changes
		so, it is not the view that decides on threading
	which non-UI operations should be serial?
		operations on any one model, obviously
		note list and a notebook could be modified simulatneously
			to search while syncing
			except for copying from the notebook to the note list
	solution
		model-wide locks
		only call getters while holding a lock
			everything that is called is called inside some lock
			so this condition makes no sense
		do not make signals from getters
		need another solution
database
	access should be encapsulated
		a separate class should return data from the database
			notes
			notebooks
			tags
			user data
		notebooks should not store notes
		but notes could still be accessed through notebooks
			notebooks could have references to the user model
			which would manage store and cache
		the alternative is to pass notebooks to user model
			which is awkward
	caching should be explicit
		caching policy should be flexible
		consumers should not know what is cached
	who should query the database
		UserModel should return ready-to-use data
		this data can come from cache or store
		UserModel has little other logic
		so let it do it
	editing
		edited notes have to be synced
			replaced with EN's versions
		editing needs to be fluid
			reloading note list bad option
		solution
			edit in-place
			signal editing complete
			notify UserModel
			mark the note for sync
			have UserModel signal note update
HTMLayout event handling
	alternatives
		process events within window
			- need a map indexed by two values
		create element behaviors
			- writing a class to foward a cilck
			- event switch
			+ easier attachment
HTMLayout resource loading
	by name
	maybe they could all be classified as HTML
sync with Evernote
	can implement sending by email at first
forward declarations
	should be made for interfaces in headers
		done
note access
	most data transformation should be done by data access layer
	data requests
		get a page of notes in a notebook
			filtered by keywords
			filtered by tags
			filtered by creation date
		get next page of notes
		get previous page of notes
		get a note
		get previous note
		get next note
	EN search grammar is non-recursive
	in the end, request becomes an SQL query
		same kind of filter can be combined
	solutions
		specialized functions, like GetNotesByNotebook
		generic function; client provides filters
			- verbose for simple queries
			- difficult to cache
data modification
	is database access is single-threaded?
		sync via separate connection
			can sync read/write data in one go?
			no, there can be long delays and conflicts
		wait, is it really single-threaded?
		loading notes might be time-consuming
		blocking UI for that period of time might be bad
			insead, disable some UI elements
			create a worker thread for creating the element HTML
			block UI to add one ready HTML at a time
			can be aborted
		so, data for HTML creation is loaded by a worker thread
			only one of these can exist at a time
		can other threads access the database?
			these threads would not be modifying or querying notes
			modify some other data?
				notebook name
		SQLite has three modes
			single-threaded: only one thread
			multi-threaded: one thread per connection
			serialized: multiple threads per connection
		target multi-threaded mode
	database access from sync thread and ui thread
	ui thread and ui data thread are different threads
		ui thread
			processes messages
			enqueues data tasks
		data thread
			executes data tasks
			sends messages to ui thread
	so, what happens when the user enters a new note title?
		ui thread asks data thread to make the modification
		data thead comits the modification transactionally
		data thread notifies ui thread of completion
		ui thread changes the note title
	GUI is only modified in response to window messages
	view classes can have setter methods
		if they do not modify GUI
			therefore, can be called from other threads
		also, if they do modify GUI
			these methods post window messages
	should there be different db models for sync and processing?
		no, they return the same data types
	should there be different db instances for sync and processing?
		each instance with its own connection
		each with its own caching, if needed
		seems like a good idea
	so, how should last used notebook be returned?
		stored as a name-value pair
		db passes a notebook object to the user model
		the user model passes it to the presenter
		the presenter processes it
		maybe creates some new object for a view
		the point is, db access is single-threaded
		so the database can return a pointer
			there is always at least one notebook
			there is always a default notebook
			the pointer should never be null
		if the pointer is never null, it can be a reference
		the class member can be a pointer
			assert not null before returning the reference
threading
	I don't want to implement threading right away
	but threading should be easy to add later on
	the threading model is dictated by sqlite and htmlayout
	each db instance represents a db connection
	access to each db instance is single-threaded
	all ui should be single-threaded
	we therefore have a ui thread and a thread per db instance
	ui thread
		signals from ui create data thread tasks
			presenters handles this
		ui getters send messages
			ui handles this
			sending on the same thread does not lock
			signal handlers from data threads should avoid getters
		ui setters post messages
			ui handles this
	data thread
		one per db instance
		should then be implemented in the db
		the db should have a message pump
	want to avoid bothering with messaging and tasks for now
database
	when should it be initialized?
		when it is being created
			check if the database is empty
			check for the properties table
		in future, when converting an old format
	how should it be initialized?
		assuming it is empty
		create tables
			properties
				version
				user name
				last used notebook
				default notebook
			notes
mobile testing
	need simple alternative to boost::test
	can copy stuff
	how can I implement AUTO_TEST_CASE?
		create a function taking a Test parameter
		add a pointer to the function to some global list
			how?
		create a base that adds itself to the global list on construction
		create test case classes that inherit from the base
		create a static instance of every such class
identity
	notebooks are identified by GUID
		but also have unique names
	unsynced notebooks have no GUID
	therefore, names are the real identifier
	what about notes?
	they don't have unique names
	when I want to open a note, a have to refer to it by some id
		by GUID
	therefore, notes need to have GUIDs
	maybe notebooks should have GUIDs too, then
	they can be assigned GUIDs automatically between syncs
	these would be replaced by server's GUIDs after sync
		views would have to be updated after sync completes
	also, the DOM elements need a GUID attribute
sync update
	GUIDs change after sync
		and possibly other fields
	if the note list is being displayed
		the query should be repeated
	if a note is being displayed
		it should be fetched from the database again
		deleted if absent
		but how, if it's GUID is old
		need a map from old GUIDs to new
	if a note is being edited
		TODO
mobile testing exceptions
	are often not caught
		fixed
	also need to test for exceptions
		done
mobile testing fixtures
	setting up the database every time is taking up space
	need two different classes
		global one to register the test
		local one to be created with a  fixture
UTF8 strings
	vector<unsigned char> is a bad container
	can't get a pointer when empty
	can add checks for empty vectors
data store initialization
	sqlite3_open_v2 creates a database that is either
		has no version
		has lesser version
		has greater version
		has correct version
	it is better not to try handling invalid databases
		what about db creation errors?
			up to ACID to handle
note import
	EnImporter needs to allocate notes
	no need to have them live outside OnImport handler
	options
		create EnImporter locally
			- can't use an interface, then
		have EnImporter use outside storage
			- different from DataStore
				maybe DataStore is the one that needs to change
				if it does not want notes to live between calls
		make EnImport clear its memory
			- extra call; might forget
SQLite wrapper
	need to destroy statements automatically
note list design
	need to set overflow for titles etc
		done
data interface revamp
	is there a need for INote, INotebook, ITimestamp, or ITag?
		they contain no complicated logic that might need to be mocked
		removing them would cut down the number of classes by 12
		what if I decided to add complicated logic later?
			like, connect them to the database
			seems like a bad idea even without the class overhead
	how should these objects be passed around?
		constraints
			avoid copies
				create a list of content
				pass it to the end consumer
				without caching
			single-threaded
			notes can be imported
			note info used for note list display
			note info can be edited
			note content displayed occasionally
			note content can be edited
			can filter by tags
			can rename notebooks
			can change default notebook
			can change last used notebook
		note list view does not have to store notes
			can store query
		currently
			query database
			cache the result in the note list model
			get results from this cache for the view
		alternatively
			store query in the note list model
			query database by note list model
			pass results directly to the view
		database queries can be stored by either value or pointer
			std::vector or boost::ptr_vector
			we no longer use interfaces for data
			so, no use for ptr_vector
		implementation
			database query functions return (const vector &)
			note list model returns (const vector &)
				where does it get it from?
				can either get it directly from user model
				or cache it
					can store the reference
						can't switch references
						store a pointer
					but then initialize it with an empty
					have to store the empty, as well, then
					good for resetting, actually
			presenters iterate through vectors
			view functions add entries one by one
	user model / data store split
		right now, they have almost identical interfaces
		a database is per-user
		user model controls database lifetime
		user model contains the database object
		separate user model would be used for sync
			with separate database connection 
			with read-write rights
			except, no use in creating a new database for sync
				so, different loading policies
		maybe data store should be a thinner sqlite3_db wrapper
			with a statement wrapper, as well
				RAII
				lazy parsing
		then user model should allocate a database and statements
			then call statements as needed
		thin database and statement wrappers are easier to test
			user model can then be properly tested on PC
			also avoiding untested private methods
database use testing
	mock database can't evaluate SQL
	might be better to just use the real database
	then I will need a real database whenever I involve UserModel
		for almost all tests, that is
	but, no; I can use MockUserModel instead
	test only UserModel itself with the mobile test suite
full-text search
	don't want to store raw note bodies in the FTS table
	because they contain tags and other stuff we don't want to search on
	even title, actually, might contain special markup
	should store originals in the note table
	should store stripped text in the FTS table
note view class design
	constraints
		modal
		create note view as child of note list view
		subscribe presenters to note view events
			presenter initialized after view
		might want to cache data for the view
			including window
		should not expose window-specific things in interface
menu bar handling
	constraints
		sends commands to a specific window
		is a top level window
		should have different buttons for different active windows
note resources
	requirements
		render pictures
		play audio
		attach files, audio, and pictures
		search images
	constraints
		identified in note contents by hash
		zero to many resources per note
		has MIME format
		has format-specific fields
		has recognition data
		has zero or more attributes
	choices
		one class with all necessary fields
		multiple classes
			common interface
			no common interface
	one class scenario is wasteful
	would also add unecessary logic
	multiple class scenario seems better
	no need for common interface
	there are few common operations with resources
exception testing
	requirements
		test that exception of the given type is thrown
		test a specified predicate on the exception
	plan
		take the statement
		give it catch of the specified type
			check the predicate there
		give it an ellipsis catch
			report an error
note resource handling
	requirements
		should be handled by NoteView
		others should be handled by HTMLayoutWindow
	HTMLayout gets requests through notification subscription
	can make the function virtual
	ask the descendant to call the base implementation
	there are several ways to fufill data requests
		send a signal with a blob reference
			- new type of signal required
			+ can protect against multiple providers
				by only letting one connect
		send a signal, provide blob setter
			- does not protect against multiple providers
			- non-local data storage
		a data loader object
			+ guarantees retrieval
			- introduces model dependcy
	special signal seems like the least of evils
	the lack of good choices is due to the immediacy of data loading
	the function has to return LOAD_OK right away
note resource storage
	requirements
		data should be available while it is loaded
		data for more than one note might be needed for one view
			for transitions
	data should be stored by the presenter
	does it?
	if it only needs to be available during loading, storage in view is enough
kinetic scrolling
	basic premise
		play scrolling animation
		mouse drag creates impulse
		friction reduces impulse
		animation stops when impulse vanishes
	animation
		similar to a game loop
		scroll continuously on idle
	state
		idle
			mouse down, move beyond threshold → dragging
		animating
			mouse down → dragging
			velocity drops below threshold → idle
		dragging
			mouse up → animating
				set velocity
		refactoring
			does it make sense to handle animation in another class?
				math
				state management
				make explicit data needed for state transitions
			interface
				SetStateAnimating
				SetStateDragging
				SetStateRefactoring
				GetState
				GetDistance(time)
			dragging and animation are fairly separate, though
			dragging is strongly tied to message processing
event subscription
	applications
		window subscrption to button clicks and selection changes
			call void() function in response to event
		kinetic scrolling animation
			scroll control in response to mouse events from it
		note flick animation
			repaint note view in response to mouse events from it
	requirements
		bind to specific elements
		bind by selector
		subscribe with the correct parameters
		subscribe member functions
	handler signatures my differ
	can create adapter functions
		that will convert parameters and call the given handler
		of a given object
	but the function pointer would require the subscriber's specific type
	how does boost::signal solve this problem?
		takes a slot_type reference
		slot_type is an object
	how does SWL handle this problem?
		creates a static proxy for each object type and message id
		supplies specialized message parameter object
	we have two scenarios
		one object handles behaviour events from multiple elements
		one object hnaldes miscellaneous events form one element
	it makes sense to keep the old system for the first scnenario
	subscribe event_handler obects for the second
	why oh why did I not stop at this point?
animation
	two message loop modes
		static
			GetMessage
			check for a "start animating" message
		animation
			PeekMessage
			repeatedly call animation functions while idle
	animation class
		provides
			flag for stopping animation
			step frame function that runs some animation
			methods to subscribe and unsubscribe animation functions
note preview
	want to display the thumbnails in note list
	have to insert the <img /> tag into the note html
	add a LoadingData handler to NotePresenter
	where to get the image data from?
		generate on the fly or pull from the database
		database storage can't be permanent
		because format may change
		although, this can also be made part of the data format
		except, we may decide to change format based on screen orientation
		even if it seems like a bad idea at the moment
	how to generate the data?
		HTMLayoutRender
			takes window handle, bitmap, and rectangle
			should use native format (16bpp)
		does it render to bitmap area or to window client area?
			client area
		how can I load HBITMAP data?
			could implement an event handler with on_draw
			seems like the way to do it
			also answers the question of whether caching is necessary
			if I draw, then it is
		so, the general idea is
			note list presenter
				clear title and subtitle
				set note body
				render to an HBITMAP array
				set the index as an attribute
			note list view
				subscribe to draw events from the newly added notes
				in handler, get the index attribute
				signal for HBITMAP with given index
				draw using the returned handle
		now both note and note list presenters are handling note list changes
		but if images are cached in the database
		then note list presenter will need to pull them
			to avoid making unnecessary queries
		actually, the note window would be creating the bitmap initially
			Render(HTBITMAP & bmp)
		then note list presenter needs access to note view
	implementation
		√ get HBITMAP drawing working
		add rendering
		add caching
	note view does not exist when notes are initially loaded
		on note list view creation
	note view is required for preview rendering
	therefore notes should be loaded after both views are created
	maybe main should initiate user loading manually
	image creation
		there seems to be no way of getting the bits
		CreateDIBSection hands out the pointer
		Imaging library can be used for processing
sync
	when sync connects to EN, the password might be rejected
	then sync brings up the signin window to get a new password
	two ways to proceed
		modal
			spin a new message loop in the signin window
			return control to sync when finished
		non-modal
			generate a request event and suspend sync
			generate a completion event and resume sync
	keep in mind that sync is in a separate thread
		any signals it sends are processed on its own thread
		sync has a separate user model with a separate db connection
		we don't want 2 UI threads
			so sync needs to display the dialog on the UI thread
		2 ways to run code on the UI thread
			window messaging
			main message loop augmentation
	general scenario
		sync does its own thing
		UI does its own thing
		sync gets in trouble, asks UI for some data, goes to sleep
		UI interacts with the user, gets sync its data, resumes it
	how to enable this
		the presenter would interact with sync's user data
			under assumption that sync is sleeping
		sync cannot signal an event directly
			has to leave some sort of message
	SyncModel
		presenters subscribe to events
			standard Connect methods
		sync calls method SetCredentials and blocks
		message pump calls Process, which signals events
		presenters modify sync's credentials model
		finishing the event unblocks sync
	lets look at it from another side
		sync starts with user credentials and runs until either
			it runs to completion
			the credentials are rejected
			some other error occurs
		sync starts when
			the sync button is pressed
			invalid user credentials are updated
		this no longer looks like a parallel thread
			rather like a worker thread
	SyncModel
		Sync method
			starts a new thread
			runs sync to one of the termination conditions
			if credentials are needed
				posts the appropriate message
					PostThreadMessage
				message loop asks it to dispatch the message
		DispatchMessage
			if sees the message sent by Sync
				raises the credentials.Updating event
				checks whether credentials were set
				restarts sync, if they were
	too much logic inside the model
	need to split this into a model and a controller
	SyncController
		initiates and controls sync
		displays credentials requests
	SyncPresenter
		runs the Sync method
		posts events to the window message queue
	instead of using Windows messaging, SyncModel can have its own
	much of the syncing code would be in EnService
	how much?
		download/upload notes, notebooks, resources
signin
	two sources
		sync needs new credentials
		anonymous user conversion
	what kind of presenters do they call for?
		UserSigninPresenter
			subscribes to NoteListView.SignIn
			updates current user's credentials
			converts the user to a named one
		SyncSigninPresenter
			subscribes to SyncModel.NeedCredentials
			updates the sync user's credentials
			restarts sync
		could sync and main user models end up with different credentials?
			do not cache them, but store in the database
	should signin update the user's credentials?
	after all, it is not his credentials that are set, but the next user's
	what to call these credentials?
		newCredentials
thumbnailer
	overview
		takes an HTMLayout window handle and a thumbnail size
		creates a window-sized DIB
		renders the window into the DIB
		creates an image object
		resizes it to thumbnail size
		creates a memory stream
		encodes the image as a jpg into it
	the imaging API is much too complex
	lets try using the graphin library
		jpg support not compiled
	JPEG options
		Imaging
			complicated
		libjpeg
			complicated
		graphin hack
			might be impossible
	went with the Imaging option — it works
	the note view shoud hide its UI when not shown
		TODO
	error handling needs testing
		TODO
thumbnail storage
	store the thumbnail with the other note data
	record the size, to update, if size requirements change
	retrieve the thumbnail with the note guid
	check the retrieved thumbnail size
	if different, replace the thumbnail
anonymous user
	now called [anonymous]
	disallow signing in with this username
		done
	add a test for this
		done
user management
	right now, the Evernote credentials are used for user's credentials
	what if I decide to add support for another note service, such as OneNote?
	then things become much more complciated, so lets not do that
	if I decide to switch from Evernote to OneNote, there would be no problem
	what about passwords?
	do I store the password for the last user only, or for all users?
	when a user signs in, he has to enter the password
	so there is no use in storing it
	what if the user logs out accidentally and has no access to network?
	he should be allowed to log back in
	so we don't check password on login
	however, sync needs the password
	it is better to get it from the database
sync
	must be capable of full sync and incremental sync
	full sync = clear clean records from db, then perform incremental sync
	implementation plan
		UI
			sync button
		user management
			last user
			credentials storage
		data model
			transactions
		threading model
			sync thread spawning
			sync result processing
				can skip the signin requesting for now
		download headers
			clear database
			authenticate
			getSyncChunc with afterUSN=0
			getNote
		full download
			download resources
		sync
			implement generic negotiation logic
			apply it to tags, notebooks, notes
credentials
	user credentials should be fetched from the database, not cached
		username and password in a single transaction
	new credentials should be cached
	there is no need to subscribe to user credentials updates
	so, we can create a POD credentials object
transactions
	which operations are performed with UserModel?
		EnImportPresenter::OnImport
			get last used notebook
			add a bunch of notes
			add a bunch of resources
			retrieve the notebook notes
		NoteListPresenter::OnLoadThumbnail
			get thumbnail
			set the thumbnail
		NoteListPresenter::OnUserLoaded
			get all notebooks
			get last used notebook
			retrieve the notebook notes
			get credentials
		NotePresenter::OnLoadingData
			get an image resource
		NotePresenter::OnOpenNote
			get a note body
			get a note
		SearchPresenter::ResetNotes
			get last used notebook
			retrieve the notebook notes
		SearchPresenter::SearchNotes
			get last used notebook
			retrieve the notebook notes
		UserLoader::Save
			get credentials
		UserSignInPresenter::OnCredentialsUpdated
			load
			set credentials
		UserSignInPresenter::OnSignIn
			get credentials
	transactions clearly have to be handled outside UserModel
		need to create RAII transaction objects
	imortantly, how to test transactions?
		have to create two UserModel instances
		the instances have to access the database concurrently
		on different threads
		have to make sure the database blocks properly
		one thread needs to
			enter a transaction
			make a write
			spin off another thread
		the second thread needs to
			enter a transaction
			try to make a write
		the first thread needs to
			make sure the second thread is blocked
EnService sync interface
	tasks
		download notebooks
		download notes
		download resources
	no, wait, server state is retrieved in chunks
	therefore we can't make separate requests like this
	tasks
		download state
		download resources
	both the client and the server can change during synchronization
	what we want to do is
		download the data at the moment of sync
		minus those pieces that are deleted during sync
empty notes
	occur during partial sync
	can either
		show them somehow specially
		not show
	the latter option is preferrable
		fewer user distractions
		less program logic
	better yet, don't commit empty notes
an unhandled exception is raised at startup
	the "Database could not be loaded." exception
	fixed
notes are not synced until I click anywhere
	because sync messages are only processed after windows messages
	if no windows message arrives, sync waits
	solutions
		send windows messages
		wake up the thread on sending
layout problem
	menu moves if I click before notes appear
	the body keeps its size
	the window keeps its size
	list view mouse handlers play no role
	the culprit is the hiding of the profile name
	how about we do not hide it?
	but instead set it to some neutral string
	after all, even the anonymous user might want to see some profile info
note images
	only the last image is displayed
	because of the way caching works
	cache all the images
	clear the cache when the page clears
	actually, this might not be the problem
	need to convert gif images to png
		no, the base64 decoder was incorrect
		need to add a test for trailing newline
		done
	now, there is an encoding problem
resource upload
	need to return several pieces of information for each
		data
		hash
		mime
	also, it would be better to copy to the final array right away
sync logic
	want a separate component
		that will make decisions to follow
	full sync
		logic
			if remote, not local
				add local
			if remote, local conflict
				if dirty
					merge
				else
					rename local
			if local, not remote
				if dirty
					upload
				else
					delete
			if remote and local
				if same USN and clean
					do nothing
				if same USN and dirty
					upload
				if remote USN higher and clean
					replace with remote
				if remote USN higher and dirty
					merge
		data
			remote: availability, GUID, USN
			local: availability, GUID, USN, dirty flag
		decisions
			add
			merge
			rename
			upload
			delete
			do nothing
	incremental sync
		logic
			if remote, not local
				add local
			if remote, local conflict
				if dirty
					merge
				else
					rename local
			if local and remote
				if dirty
					merge
				else
					replace with remote
	difference between full sync and incremental
		starting USN
		same USN handling
	EnService should contain as little logic as possible
		factor it out later
	SyncLogic usage
		build the remote resource list
		build the local resource list
		process remote-only, local-only, and conflicting
	resources to sync
		notes
		tags
		notebooks
	resource list building
		identity via guid
		build full local and remote lists
		build a guid set for each of the lists
		traverse each list
			checking the guid sets
			calling the appropriate sync function
	data types
		locally, we have Note, Notebook, and Tag classes
		each has a GetGuid method
		EnService could return same classes
		the classes then also need to have GetUsn and IsDirty methods
	need to know which notebook to upload a note to
		should sync by notebook
		then I can set the notebook for the whole NoteProcessor
	this ad-hoc "getting it to run" approach results is messy
		suspect much wasted effort
	need to refactor EnService
		should provide only basic services
			login requires credential verification
			SyncModel needs to fetch remote resource lists
			SyncLogic performs the following operations
				Add(remote)
				Delete(local)
				Rename(local)
				Upload(local)
				Merge(local, remote)
			note addition entails resource download
			uploading entails local note replacement
		this requires the following 
			CheckCredentials
			ListEntities
			DownloadNoteResources
			UploadNote
			UploadNotebook
			UploadTag
		many of these operations are interdependent
			sync resources determine what gets downloaded and uploaded
			need to upload and download notebooks and tags before notes
		there should be a minimum of logic in EnService
		it should be a dumb adapter between app logic and EN API
			it should handle EN exceptions
		EN works by sessions, therefore EnService has to expose sessions
			can expose user store and note store sessions
	sketch
		EnService
			GetUserStore
			GetNoteStore
			UserStore
				GetAuthenticationToken
			NoteStore
				ListEntities
				DownloadNoteResources
				UploadNote
				UploadNotebook
				UploadTag
	exceptions
		maybe EnService should catch exceptions and return error codes
		to avoid building CheckCredentials logic on exceptions
		if the stores are RAII objects, then they cannot be returned
		overall, connection problems are entirely expected
		adding an error handler for broken connection is another alternative
		we don't want to keep working with a store, if the connection is lost
		so, throw on connection lost
		GetAuthenticationToken should return an error message
	sync sequence
		tags and notebooks are independent
		they get synced first
		we only want to sync notes in the current notebook
		however, the current notebook might not exist on the server
		it might even get deleted
			ohi, sync dis notebook plz
			nowai! i deletd it
		in such a case, deleting the notebook is all that's needed
		if the notebook did not exist and was uploaded, populate it
		in either case, the remote note list will be empty
		how do I find out that the current notebook was deleted?
			in such a case, lastusednotebook should return the default
		do I need to find this out?
			if  the notebook is deleted, the remote note list is empty
			the local note list is also empty
			syncing is then a NOP
			as long as I get the current notebook before deleting it
	note resources
		once a decision to add a note is made, its data needs fetching
		getNoteContent requires note Guid — easy
		getResource requires data Guid
			these are not stored in our Note classes
			this is the only place in which they are needed
			so, it does not make sense to add them to the Note class
			could add a class to package note with resources
			peform sync logic on that
			what to call it?
				NoteWithResources
				EnNote
				TransferNote
				NotePackage
			something to say that it includes everything for EN interop
				EnInteropNote
		upload requires several pieces of information
			data
			guid
			mime format
			hash
		need more sophisticated resource objects
			blobs not sufficient
		this could be useful in other places, too
		these would be large imuutable objects
			do they really have to be immutable?
			what if I want to dither a bitmap before rendering it?
			I am not sharing it with anyone, if I hold the memory
		need to return them via shared pointers or pointer arrays
			is there another way?
			want to avoid reference counting and memory allocations
immutable class storage
	returning an immutable class copies it
	an immutable parameter cannot be initialized via reference
		because it is constracted before function call
	this means that these can only be returned by reference
	would like to have a class that is mutable until fully constructed
errors
	smileys do not show up
	thumbnails do not scale
	an unnamed database is created
	cause: freak VS error
	cause:
		restarting the device emulator with old code
		not selecting client for deployment
		running client
testing
	need to update tests for update processor upload functions
	replacements need testing
	can't test NoteProcessor, since it talks to the server
notebook deletion
	deletion of the default notebook should not be possible
		throw on attempt
		the alternative would be to just delete all notes
		but this is not a necessary user story, for now
	deletion of the last used notebook should reset it to default
		handle this in the user model itself
	add tests
		done
sync logging
	need to record data going in and the operations performed on it
	it should be possible to disable it
	keep in mind that other parts of the application may also need logging
	I want to view information in a file
		this file can either have sync-specific format
			or a neutral format
			or a mix of formats
	say, I am logging performance data, as well as sync
		I don't want them to mix
		therefore they can't be writing to the same stream
	if they have different streams, do they have anything in common at all?
	if not, instantiate a bunch of logger objects in main
		pass them to appropriate classes by reference
	the objects could be initialized in main
		then adjusted at runtime
	seems like a flexible approach
	how do I display item actions?
		items need to be identified somehow
		GUID is not a convenient identifier
		but it is the only one that is unique
		therefore we'll use it
		no use in shortening it
		can always scan by the first characters visually
need to refactor SyncModel
	the SyncContext looks like a really bad idea
	it duplicates most SyncModel members
sync troubles
	have a remote notebook and a local notebook
	same name, different Guids
	the algorithm downloads the remote and uploads the local
	yet, names have to be unique
	same thing with tags
	the algorithm has no provision for this
	fixed
database constraints
	notebook deletion should cascade to notes
	note deletion should cascade to resources and FT3 data
	tag names should be unique
	notebook names should be unique
	adding a note, noteboo, or tag should replace the one with the same key
		do INSERT OR REPLACE
sync ui
	which presenter should be responsible for updating the sync indicator?
	which ones shows it in the first place?
		NoteListPresenter
			OnUserLoaded
	same entity should keep track of its contents
	the dirty note count is a property of the notebook
		what about dirty notebook count?
		what about dirty tag count?
		they should be added together
	the total dirty count is a combined measurement
notebook selection event
	notebook list is modified dynamically
		during loading and during sync
	ConnectBehavior might be called any time after loading
		this seems to be consistent with current implementation
	however, ConnectBehavior takes a path
		I have a handle, instead
	there might be a need for a NotebookListModel
		SyncPresenter would update it
			on the UI thread
		NoteListPresenter would react to the updates
			by updating the menu and the behaviour connections
	notebook removal invalidates behavior connection records
		need DisconnectBehavior
		can work similarly to ConnectBehavior
item change events
	item processors need to be able to enqueue messages
	they can't use SyncContext directly
		because it is a private nested class
	maybe this is the time to reform SyncModel
	it only needs to synchronize some actions
		EnqueueMessage
			ProcessMessages
		GetStopRequested
			StopSync
	could make the message queue a separate class
		then the processors will be able to use it
		then its locking would be transparent
			and the context only needed for the stop flag
delayed sync logic
	there are a few problems with the current approach
		operations might have to be reordered
		ui needs to be updated with progress
		the actions might need to be halted midway
	all of these things would be easy, if action processing was delayed
	then there would be no need for processors
	SyncLogic would generate a list of actions, instead
	but this should be done after the sync indicator is up
		TODO
updating dirty note list on note edit
	there is currently no signal for committing note edits
	this should be a note list model signal
	how would it be triggered?
		importing notes
			trigger after updating the note list
		note edit
			trigger after updating the note
			acts on the note, not the list
			is it possible for the note to not belong to the list?
				the note would be selected from the list
					could be false for linked notes
					depends on linked note implementation
					not immediately relevant
				the list can't change during editing
				therefore the note has to belong to the list
		could set a flag, instead of signal
	could instead make it a UserModel signal
		then there would be no possible problems with linked notes
		the signal could be triggered automatically
			on note add
			on note update
		the notes are not the only thing that may become dirty
		therefore, the signal has to be triggered by the database
			when anything dirty is added
			except that changing dirty to clean is also significant
			when anything is added
		it does not make sense to send the signal from inside a transaction
		need to set a flag, signal at transaction end
		the database can be modified from multiple threads
		therefore, can't rely on SQLite to signal changes
		signalling from UserModel won't prevent reliance on SyncModel signals
			because the signals need to be sent through the UI thread
	what if I trigger the signal through EnImportPresenter?
		presenters can't expose events themselves
		therefore, it would trigger the event on something else
			user model
				should not be done without automating, I guess
			note list model
				lets do that
		then it should be a flag, not a signal
			a flag visible to SignalChanged subscribers
			reset after the signal is fired
	this is all stupid
	I only need to update the sync counter on note list update
		that's all
	no special signal is needed
	why didn't I recognize this immediately?
		thought I need to know whenever a resource was changed
		in actuality, the event of the note list changing was needed
		_note list_ presenter should not deal with resource events
			did not think of that
SyncModel refactor
	need to delay action processing
	SyncLogic should generate an array of actions
	SyncModel should process the actions once they are generated
	the processing might involve reordering
	actions would be little structs
		all the same type
			enum type
			T * local (nullable)
			T * remote (nullable)
checkbox support
	general idea
		keep a list of the checkboxes
		when the note is opened
			record the initial state
		when the note is closed
			compare state with the initial
		if the checkboxes have been changed
			update the note body
			store it in the database
			mark the note as dirty
			update the note list
	parsing
		can either parse the notes twice or keep track of offsets
	can this be somehow generalized to regular note editing?
		checkboxes would have to be active then, also
		generally
			we would be editing HTML DOM
			then serializing it into EN's format
		we might still want to keep a list of checkboxes
			to recognize changes
			the alternative is to subscribe to events
				would enable immediate visual feedback
				we might want to let the user know the note is dirty
		editing requires complete note information in DOM
	hold that thought
	checkbox is special
		it does not clearly imply editing
		the user would not expect any other changes to result
	it seems, checkboxes should not be implemented as general editing
	back to the conservative approach
		keep a copy of the original note body
		record offsets to checkboxes
		record checkbox states
		on exit, check states, option
	implementation
		notes are processed by EnNoteTranslator
		can RapidXML return element positions?
			possibly, with non-destructive parsing
			then attribute value offset can be used
			however, entities will not be translated
				conversion is to HTML
				entity translation unnecessary
		this cannot be used during transformation, though
			transformation implies destructive parsing
			does it?
			not necessarily
			need to check
				no it does not
		record checkbox info during transformation
			how to retrieve it
				have value location, size, and content
				need to convert location into offset
					need main string location
			how to represent it
				need to store
					state
					value location
					value size
				add a POD class for this
					used during translation
					output from EnNoteTranslator
					stored by the note
						view, presenter, or model?
					global class
			how to store it
				transformation function has fixed signature
				therefore need to store it as class member
				can also store the main string location there
		new state retrieval
			the note view gets a slab of HTML
				no DOM elements to subscribe
			can find them via a selector
	problem: "checked" attribute is optional
		should replace the whole element
		RapidXml only stores name and value offsets
		could search for opening and closing brackets from name
		unless the tag has a separate closing tag part
		in which case proper XML parsing is required
	general editing is the only viable way to go
	implementation
		encoding
			have EnNoteTranslator save as much information as possible
		reset
		decoding
			new functionality for EnNoteTranslator
		dirty tracking
			"reset" reloads the note, makes it not dirty
			subscribe to checkbox behaviors
				mark note dirty on change
merging
	changing a notebook's guid requires an update operation, not delete/add
	otherwise, the notes in it will be deleted
sqlite init
	might want to call these explicitly
		sqlite3_initialize()
		sqlite3_shutdown()
	TODO
update processor tests
	testing is difficult now
		mixed with threading
		opaque
	fixed
note editor
	commands
		cancel
		checkbox
		ul
		ol
		bold
		increase indent
		decrease indent
		italic
exception handling
	exceptions should be raised by models and views
	presenters should be durable against exceptions
	presenters should keep logs
note update -> thumbnail update
	need to trigger NoteListView::SignalLoadThumbnail
	occurs at OnLoadData
	when the note is updated, the note list thumbnail should be refreshed
	"update" and "refresh" do not reload images
	need a special method calling HTLayoutDataReadyAsync
full test search
	should remove stopwords from the database
		TODO
	have to keep referential validity of the FTS table manually
	therefore, can't do INSERT OR REPLACE
		need to do SELECT, then INSERT/UPDATE
note merging
	simplest approach
		replace local with remote
			won't replace resources or tags
		better approach
			delete local
				resources should be deleted automatically
			add remote
				and the resources
"north east registry" image is not loading
	fixed
elastic scrolling
	goal
		list can scroll past the limits
		in that case, it should be attracted back
	physics
		dragging the list gives it a speed
		there is acceleration due to friction against direction of movement
		past an edge there should be acceleration towards the edge
	discontinuity
		can determine which edge the movement occurs towards
		calculate time to reach the edge
		calculate velocity at the edge
		if velocity crossed zero
			calculate position using the pre-edge acceleration
		else
			calculate position using post-edge acceleration
		friction changes direction
			when velocity changes direction
			this happens past the edge
	actually, there is very little need for any of this
tags
	rarely needed
	should not be part of the note structure
	should be retrieved like resources
	tags are different from resources
	in that a tag can be associated with 0-many notes
	how to associate notes with tags, then?
		NoteStore can retrieve tag names for a notebook
		user model should associate by name, too, then
			AddTagToNote(tagName, noteGuid);
input panel
	API
		SHHandleWMActivate
			keeps the panel consistent between activations
		SHFullScreen
			determines which elements to show
		SHACTIVATEINFO
			used only by SHHandleWMActivate
signing out is broken
	closed the database during a transaction
note replacement problem
	if the server replaces a note with one with the same name
		then it is duplicated on the client
	not the desired behaviour
	if the server deletes a tag, then creates another of the same name
		then such behaviour is desired
		wait, no
		we want to delete the old flag on the client, also
	what does the documentation have to say about that?
		if a tag withe the same name, but different GUID exists
		if the existing tag has no "dirty" flag
		rename the existing client tag
notebook list is not updated after sync
	the update did not fit into one 20-element chank
	implement a proper chunk retrieval loop
incremental sync
	some differences
		starts from USN greater than 0
		fullSyncOnly == false
			chunks contain expunged objects and resources
		assumes new resources have greater USNs
		does not delete local resources absent in remote
	implementation differences
		start from a non-zero USN
		specify fullSyncOnly == false
		list resources
		list expunged notes, notebooks, and tags
		update resources
		remove expunbed notes, notebooks, tags
	affected code
		new NoteStore.ListEntries function
			calling getNextChunk differently
			listing additional stuff
		Sync needs to be split up into full and incremental parts
		database needs to store last sync USN and time
		noteStore needs to fetch fullSyncBefore and updateCount
	updateCount
		if we sync by notebook
			we have to store updateCount by noteBook
			except, notes are not the only synced entity
			there are other things, like notebook deletions
				we don't want to double-sync them
			but note events want to be per-notebook
			can keep both global and per-notebook USN counters
			notebook USN ≤ global USN
			could sync using notebook USN
				sync notes with USN > notebook USN
				but filter out global events with USN ≤ global USN
			would this cause double-sync problems?
				global USN always gets reset
				therefore, no global double-sync
				a note can only belong to one notebook
				a notebook's USN gets reset when it is synced
				therefore, no note double-sync
			any other problems?
				a note belongs to exactly one notebook
				therefore, no missed notebooks
				global resources are updated normally
				therefore, no missed global resources
				do global resources depend on notes?
					tags      - no
					notebooks - no
					searches  - no
					resources - yes
				a resource belongs to at most one note
				therefore, resources should be synced per-notebook
				do global resources depend on resources?
					tags      - no
					notebooks - no
					searches  - no
				no other problems, then
			expunged resources do not come with USNs
				can't filter out glogal resources
				might double-delete global resources then
				is this a problem?
				could be, if they can be restored
					can't be
					API ref says expunging is permanent
				does not seem like a problem
		what about sync time?
			required to decide when to peform full sync
		delete vs expunge
			deleted notes can be restored
			deleted notes have USNs
			can I add deleted notes to the expunged notes list?
				to simplify processing
			either way, we remove the note
				and all of its resources?
		deletion
			incremental sync sees deleted notes that were never added
				if the note was added and removed before last sync
			could attempt to delete them, just handle the exceptions
	notebook note filter
		should be at ListEntries level
			for pulling changed
			if it does not exist on the server
				there will be no notes to pull
		should be at ProcessNotes level
			for pushing changes
			if it does not exist on the server
				it should be using updated data
performance profiling
	requirements
		always on
		little overhead
		easy to maintain
	targets
		animation frame rate
			for various animations
		loading time
	implementation
		no string map
			premature pessimization
		animation
			FPS = # of frames / seconds it takes to complete animation
				record when an animation starts
				count the frames in the animation
				add a performance event when the animation ends
			how to store this additional data?
				currently done with a signal
				would need to keep additional state with each connection
				does the signal library allow this?
					no
			if I don't use signals, what should I have?
				connection creates a record with
					id
					active flag
					the function to call
					the object to call the function on
					animation start
					frame counter
				connection returns an object for severing it
					severing means removing the record
					can't do it by index or pointer
						because these get invalidated by other removals
					type needs to be known to animation provider
						entails type of list it is handling
						entails type of record
				animation id
					could be supplied by animation source
						assuming one animation of a kind plays at a time
					knowing what ids there are, can preallocate the records
						add a flag to mark active ones
						does not seem like a good idea, though
					does not seem like a clean solution
						it leads to a clean solution, though
				what's in a clean solution?
					animation provider deals with the animator interface
					provider given a connection object
						without revealing animator implementation
				solution
					give the connection object
						connection id
						animator interface reference
		collection
			every time an animation finishes
				record the frame rate for its type
			this means I need to know the type of animation
			also need a place to record the frame rate
			MVP implementation
				create a profile model and a profile presenter
				the presenter would subscribe to various sources of profiling info
					and record them to the profile model
				the presenter might react to to changes in the model
					and update some special debugging view
				report presenter, or whatever, might also hook up to the profile model
			animation signal
				is it, really, appropriate?
				would require methods like
					ConnectAnimationCompleted
					GetLastAnimationId
					GetLastAnimationFps
	display
		show in status bar
note editing
	switch modes between editing and viewing
		no, only go from viewing to editing
		lets us use a separate editing window
	layout
		toolbar
		title
		tags
		editing surface
		ok-sip-cancel
	separate window
		separate MVP
note state for editing
	problem
		windows contain only partial note state
	current solution
		store remaining state in the presenter
	make sense, because view does not need the full state to function
	also, note body is not part of the Note structure
	except
		note is associated with exact combination of views and editors
		event though it is specific to the view alone
	if a note is to store complete note information
		it would have the logic for saving state to it
		this logic probably should not be in the presenter, anyway
		since it does not reflect user stories
		lets try it
	note translation
		should not be performed by the view
		the view should get translated bodies
		what about the subtitle?
		it contains a formatted tag list
	the view should take a Note in additiona to all the other data
		not instead
editor implementation plan
	√ implement proper state saving
		for editor, not viewer
	√ test current implementation
		creation
		editing
	update tests
	standard formatting commands
	checkbox insertion
	presentation
		command buttons
probably should rename view.hide to view.close, where appropriate
	TODO
losing formatting
	open opening a created note
		could be during opening or saving
	TODO
should factor out URI loading
	kinds of URIs
		relative
			no colon
		thumbnails
			thumb:
		note images
			img:hash.ext
	what to do with asynchronous thumbnail updates?
		use the loader
	thumbnail updates
		when the thumbnail is absent or has wrong size
			it is created and stored in the database
		this requires the note guid
			embedded in the url
	problem
		thumbnail creation requires NoteView
		NoteView requires html data loading
		we have a recursive relationship
	one solution is to
		set the link
			after iniitializing the views
			but before showing them
		would change the reference to a pointer
	another solution is to
		not generate thumbnails lazily
		generate them on note creation and editing instead
	yet another solution is to
		hook up html data to views loading via a presenter
		as a bonus, the views won't all have to change constructors
		however, HTMLayout subclassing in an implementation detail
		it would not be visible to a presenter
		URL loading should not be exposed in the interface
		however, the presenter could take HTMLayoutWidow references
note resourses are not uploaded
	after importing a second smiley note
		the sync action is Add, not Upload
	EnInteropNote lacks resources
		they are not handled at all in SyncModel::GetNotes
	fixed
notes are uploaded to the wrong notebook
	should set default notebook prior to upload
	should be set in set in Note.notebookGuid
	fixed
updating note title fails
	ENML validation
	double <en-note>
	fixed
Thrift malfunctions
	getting a 1 GB message
	actually a 405 error: GET not supported
	strange, because I use POST
	was using wrong URLs
checkbox graphics are not loading
	should have returned LOAD_OK for unknown resources
		not LOAD_DISCARD
selection in edit view is not visible
	HTMLayout bug
	fixed
notes do not pass ENML
	needed to specify ENML2.dtd
updated note is uploaded as a second note
	API has separate function for updating
	might want to create a separate action for updating
	can't tell whether a note already exists on the server
		for incremental updates
	need to mark unsynced notes
		by assigning special GUIDs
		prefixing or postfexing a special character
		postfixing is cheaper
			it is the more common operation
sync testing leaves much to be desired
	updating, logging
	TODO
can't open updated note
	even after restarting
	preview does not update
	crashes on exit
	crashes even on download
	crashes on opening synced notes
	ReplaceTodo had a bug when
		a todo div was present without a "checked" attribute
paging
	can implement either in view or in model
	NoteListModel can limit itself to accepting only a set number of notes
	after that, display paging controls
	paging controls fetch more data into NoteListModel
	how to implement paging
		some people have thousands of notes
		would it be acceptable to load metadata for all of them?
		each note contains
			guid:         64
			creationDate: 8
			name:         200
			usn:          4
			isDirty:      1
		total size: ~300
		1000 notes → 300 KB
		not too much, actually
		if memory consumption becomes a problem → use smaller notebooks
NoteListView::AddNote passes strings by value
	also AddNotebook
	fixed
scrollbar does not appear after signing in
	because all 4 notes fit
	and pagination controls are not being set
	NoteListView::UpdateNotes is called from only a single place
	NoteListView::UpdateScrollbar has zero contentSize
	could be because the window is hidden then
		or disabled
	indeed
notes are not sorted by date
	actually, sorted in ascending order
	should be in descending
new note is created with zero creationDate
	fixed
checkboxes don't work
	get drawn correctly
		in the viewer
		in the editor
	xcall asserts
the list of notes should not be a list of options
	should be a list of buttons
thumbnails are not updated after checkboxes are edited
	throws an exception
		trying to load thumbnail from resources
		fixed, but not the cause
	thumbnails are updated and saved to the database
	but not reloaded
	picture does not update, unlike img
crashes on exit after creating and updating a note with 4 checkboxes
	and after simply restarting
	coming out of HTMLayoutProcND
		WM_DESTROY
			turns off window handlers
		maybe the stack is corrupted
			it is
		how to find the actual caller?
			has to occur in either
				message handler
				destructor
					at the end of main
					does not get there
				SendMessage from the same thread
		need to change strategy
			try to reveal the bug in another place
			it happens even with an empty notebook
			r4 = 0x01a86480
	the checkbox was created with the wrong xcall
selected note can't be selected again
	changed the list to a series of clickable panels
threw an unhandled exception on attempt to commit an edited note
	edited checkboxes in the viewer, then opened the editor
	the viewer was setting checked=""
signin screen should accept "enter" in the password field
	TODO
note editor checkbox changes are not persisted
	c-smile said he'd fix this
	TODO
links should open in a browser
	fixed
sync counter is not updated after a note is edited
	reloading the list fixes this
internet address could not be resolved
	no error message is displayed
	no internet connection
sync with DonReba did not upload my notes
	probably because my notebook has the same name as the default
	update count issue?
	incremental update is done starting at notebook update count
	the fundamental issue is that notebooks have two update counts
		last note update count
			use this to decide, whether to sync notes
		notebook update count
			use this to sync notebooks
	does it make any sense?
		at sync need to get changes to notes and notebook info
		notebook USN is never smaller than the note list USN max
			because notes can be ignored, but not notebooks
		at sync we retreive changes starting with the note list USN max
		syncing different notebooks could retrieve changes from intersecting time periods
		should ignore non-note changes below global sync date
	note list USN max
		could be stored in the notebook or calculated
			calculating would loop through maybe a thousand elements...
			should not take long
			storing it would introduce an FD
				complicating logic
	note list update count is not the USN max
		it is the update count at the last sync
	implementation
		looks like the solution is
			to make notebookUpdateCount the note list max
			instead of the notebook usn
don't need to list notes for local notebooks
	currently, only the Guid is available
		should be enough
	TODO
screenshot notes
	should use distinctive notes
	lets look EN's screenshots
		mostly untitled notes
		many pictures
	only need five notes or so
		√ city place photo
		√ TODO list
		√ web clip
		√ product photo
		food photo
		nature photo
sync button is not reenabled on failure
	signing out, then back in crashes the app
		last used notebook was not set
			should this even lead to an exception?
			there has to be another notebook
				or if there is not
				could create one
		should add a test for this
			TODO
something is wrong with scrolling
	TODO
claim note title is shown incorrectly
	its just too long
in note view, apostrophies are not translated
	they are translated in XML, but not in HTML
	they amperstand in &apos; gets encoded somehow
		XML->HTML conversion should not encode symbols
		the parser performs no entity translation
		the printer does
	this also fixed other translation bugs
would be good to add encryption and decryption
	nevernote uses RC2/ECB/NOPADDING
		works in Crypto++
	nevernote remembers previous passwords
	TODO
looks like the shortcut does not work for installation onto cards
	TODO
clicking notes does not work on WM 6
	GetCursorPos does not work
	need it to get the note element
	can remember the note element in the WM_LBUTTONDOWN handler
encrypted notes show up as gibberish
	TODO
some notes seem to not have the "value" attribute set
	clickTarget was not necessarily a notedde
the shortcut is not set correctly for memory card installations
	TODO
should add a button for clearing the search field
	done
search does not limit to the current notebook
	TODO
note body indexing
	changes
		EnImportPresenter::ImportNotes
		EditorPresenter::OnAccept
		NotePresenter::OnCloseNote
		NoteProcessor::Add
		NoteProcessor::Create
		NoteProcessor::Merge
		NoteProcessor::Update
	text processing
		iterate through the tree
			output text nodes
		skip en-crypt element nodes
			should also skip en-media
				TODO
	update tests
		TODO
the menu can show only so many notebooks
	solutions
		extra menu level
			- an extra click to access any notebook
		autoscrolling menu
			- impossible, due to absense of mouse move events
		paging
			+ no clicks to access some notebooks
			- potentially, several clicks to access others
	extra menu level
		separates notes into several equal groups
			how large should they be?
			could limit maximum list length
			by equating group size with the number of groups
			sqrt(n)
			can generalize this to arbitrary depths
			let there be m, such that n^(1/m)<c
			then m=ceil(ln(n)/ln(c))
		shows the shortest differentiating prefix
			take the first entry of every group
			can make them all the same length
			find out what length it is
				find the longest common suffix for all the strings
					trim it
			we still don't want overly long names
			if the trimmed names are longer than a limit
				trim them further
				better yet, trim middles
		implementation issues
			can't add notebooks one by one to the view
			need some sort of menu structure to pass to the view
				would be computed by a testable algorithm
				could be inside a presenter
			better yet
			create HTML in the presenter
				how to subscribe to behaviors, then?
					subscribe to the menu itself and check the target
			generation
				for non-deepest levels, create title, then processes next level
				after the last member of a group, go to previous level
			iterative approach
				start at zeroth element and depth
				while depth non-negative
					if last element in a group
						end level
						decrement depth
					else
						if depth == max
							create notebook entry
							increment element
						else
							create menu title
							start a new level
							increment depth
			problem
				algorithm goes up a level
					then goes down a level
					and then back up
				need to tell these states apart
				after getting high enough up
					we want to get all the way down
				could add a boolean direction flag
					seems to work
		menu is updated from several places
			should be updated in the note list presenter
			menu creation should be done in the note list model
				we don't have one, though
	notebook updating
		is done by the sync presenter and the note list presenter in response to
			sync completion
			notebook changes during synchronization
			user loading
		should be done in response to the notebook list model changing
			should modify notebook model in response to
				sync completion
				notebook changes during synchronization
				user loading
			but these modifications should not be done by the note list presenter
			should be done by the notebook list presenter
				or sync presenter
	notebook model
		actually, there is no need for separate notebook storage
		notebooks are stored in the database
		the menu is update at specific points
		should be updated by the note list presneter
			because it is responsible for the view
		so, the menu generation code should be in...
			a separate class
			owned by the note list view
displaying a tip after full sync
	explain that
		sync is done by notebook
		the list of notebooks in the menu has been updated
		the user should select a notebook and sync again
	message
		Select a notebook from the menu and sync again.
			unfriendly commanding tone
			reason unclear
		Got your notebooks — choose one from the menu and sync again to get the notes.
			unclear that this is an instruction
		Tip: Got your notebooks — choose one from the menu and sync again to get the notes.
			too long
		Tip: choose a notebook from the menu and sync again to get the notes.
			still too long
		Tip: choose a notebook and sync again to get the notes.
			does not mention the menu
	there has to be away to clear the status bar
		could do it after a timeout
			but a user might leave the phone unattended while it is syncing
			definitely a bad idea
		could do it on click
			would clear the instructions once the user starts following them
		could a button for clearing the status bar
			no space
		could clear the status bar when it is clicked
			might not be obvious
the main window freezes when the virtual keyboard is hidden
	using HTC Keyboard
	TODO
cannot close the "about" window after switching to it from another app
	can't reproduce on WM 6.0
	WM seems to lack owned window support
		if so, have to switch to dialogs
	TODO
crash after clicking the notebook submenu, then exiting
	window should be closed with PostMessage, not SendMessage
low resolution support
	target 320x320 or even 240x240
	how to do it?
	solutions
		relative units
			- hard to guarantee proper pixel alignment
			- wastes memory
		a dynamic attribute
			- very long style
		dynamicly loaded second set of resources
			- difficult to do
			- diffucult to mainain
		compile flag for set of resources
			- diffucult to mainain
	second resource set
		store the resources in a separate folder
		give them identifiers with a special prefix or suffix
		have the tools function adjust the identifier
	dpi choice
		resources are loaded by HTMLayout::OnCreate
			it could determine the dpi
			and tell it to the tools function
			the tools function would adjust the name
		also by HtmlDataLoader::LoadHtmlUri
			not sure how it would find out the dpi
			it is initialized in Main
			can find out resolution there
	thumbnail size
		these need to be smaller, too
		NoteView::Render is called by
			HtmlDataLoader::LoadThumbnailUri
			NotePresenter::OnCloseNote
			EditorPresenter::OnAccept
		would be best to get the size from the markup
sync error
	exception thrown by SqlStatement::Finalize on notebook add
	the messsage is "(NULL)"
	result is SQLITE_CONSTRAINT
	the "Notes" notebook contains "Notes" in name._Buf
		but nothing in name._Ptr
	the error seems to have gone away after resyncing...
	was it some kind of database corruption?
		I might have forced the app to close
		but that should not cause corruption...
	or is there some other contraint?
		in this case, the error should reprdocible in tests
	what other constraints can there be?
		notebook guid uniqueness constraint does not apply
			using INSERT OR REPLACE
		the change cascades
			maybe cascading violates some constraint
				foreign or uniqueness
				uniqueness unlikely, because all keys are simple
					are they?
thumbnails are not rendered correctly
	there was a bug in the FlipImage function
	it was not using correct scaline length
sync error
	report
		slow GRPS network
		shows "incremental update" for a long time
		stops with an exception
		deleting the database does not help
	hypothesis
		high latency
			it takes too long to fetch the changes
			20 events at time
	test
		HttpSendRequest would return a timeout error
			currently, should throw appropriate TTransportException
the about dialog does not close
	it was not handling the WM_CLOSE message
	in fact, it is better to add the OK button
		and handle the WM_COMMAND message from the IDOK control
should NoteStore::CreateNote replace note resources?
	NoteProcessor.Create
		gets the old note's contents and resources
		gets a replacement note
		deletes the old note
		adds the replacement note
	don't the resources get deleted with the old note?
	TODO
need to improve error reporting
	Evernote has special error types
		EDAMUserException
			error code
			[parameter]
		EDAMSystemException
			error code
			[parameter]
		EDAMNotFoundException
			[identifier]
			[key]
	these do not set the TException::what()
	solutions
		rethrow with a specific message
			- repetitive code
		set TException::what()
			- unclear how to do
		process EDAM exceptions upon catching
			- breaks encapsulation
	desired result
		log the exception type and parameters
		display a friendly message
	need differentiation at the catching stage
	handling EDAM data would require processing __isset
		very leaky
	can't we have NoteStore provide the handlers?
		what would they do?
		they don't know how friendly the messages are supposed to be
		or else it would be leakage in the other direction
	could rethrow errors
		but that would not change the possibility of optional types
		so the new types would have to be essentially the same
	added specific handlers
	now, there is a lot of repetition
		unload the database
		reset progress bar
		decipher error code
	can make a function for cleaning up
		separate functions for generating messages
			but these would expose the classes in the header
			and the forward declarations would be too verbose
		separete function for processing error codes
			who should be doing this?
			could be used in different places in code
			in all the same places those codes are used
				could add this metainformation to the code generator
					but this would be time-consuming
			lets add this to the sync model, for now
				can always refactore, if needed
	setback
	adding message handlers is dragging Thrift into the test suite
		can avoid this by adding just TException
ink editor
	drawing is pretty laggy
		might solve by updating smaller regions
		works great
	the new note needs a title
		add a fixed title, for now
	should be able to draw dots
		done
	need to crop notes
		several ways to go about this
			BitBlt
				requires extra memory
				up to double
			bit manipulation
				error-prone
				deeper in the stack
		bit manipulation seems more attractive
photo notes
	settings
		things like
			resolution
			quality
			title
		need a way of adjusting
			at the same time, want to minimize clicks
			need to add an intermediate screen
		storage
			add a model to handle the settings
			store in the registry
	development plan
		first, add photo support with default settings
			no model
		then, add settings
	note that photos are, supposedly, always JPEGs
	TODO
window refactoring
	there is common functionality in many windows
		exiting on escape
		ok/cancel buttons
		show/hide
		class registration
	basically, two common behaviours
		viewer
			windows
				note view
				about
				profile
			behaviours
				close on escape
		editor
			windows
				sign in
				editor
				ink editor
				photo editor
			behaviours
				cancel on escape
				accept on ok
	what would be the point of this refactoring?
	some windows need subtly different behavior
	that's ok
	and none of those functions is difficult to imlement
	and there are not very many
	so lets not refactor, after all
refactor note list reloading
	this is a somewhat complicated chunk of code that is used in many places
	if it was defined in one place, which place would it be?
		note list model
	sideffect: saves some memory
	need to test NoteListModel.Reload
		TODO
	this will also help when implementing advanced search features
ink note line is too thin on high-resolution displays
	adding choice of line widths
ink editor view does not resize itself properly
	fixed
note view window "ok" button does not work
	fixed
a tag was deleted that is absent in the database
	at the same time no tags are added
		so it is not a matter of operation ordering
	forgot to set deletion action in a foreign constraint
wrong password message in the sign-in screen is not too informative
	it says "password"
	TODO
note view full screen does not get restored when the window is reactivated
	fixed
ink note drawing
	need to measure performance
		question to answer
			is drawing slow or is blitting?
		methodology
			keep two timers
			accumulate results for one second
			display statistics
				how?
				draw on the bitmap
		better idea
			keep two timers
			accumulate results
			display statistics on mouse up
				and reset accumulators
	the verdict is that neither drawing nor painting is at all slow
notes should never get empty titles
	should assign a default
	done
"begin incremental sync" takes far too long
	investigate
	does it reproduce on the emulator?
		yep
	looks like we don't get the changes from the server
		so sync logic decides to upload all local notes
	wait
	GetNotes takes a while...
		probably because it gets all resources for each note
		only resource Guids, actually
		still, it is hundreds of querries
	foreign keys were missing indices
pen configuration
	pen can be adjusted by the user
	pen settings can be restored from the registry
	the logic to handle these things should be in the presenter
	what should happen on a menu action?
		the view should record the action
		and tell the presenter that the pen has been changed
		the presenter then retrieves this record
			persists the settings
			and modifies the pen
	colour persistence
		should it be saved by name or by value?
		what's the difference?
		saving by name
			can put a checkmark beside the appropriate option
				if the value changes
		saving by value
			can put a checkmark beside the appripriate option
				if the name changes
		value change is more likely
		lets save by name
	menu management
		need to
			save menu state
			set menu checks
		could manage checks in WM_COMMAND handler
			but this does not account for changes via SetPen
			not made in response to WM_COMMAND
		how to know which menu item to change in response to SetPen?
		might want to deal with ids only
		the presenter would change ids to strings for storage
		the view would change ids to menu ids
Graphin bitmap rendering
	its great, but produces 32-bit bitmaps
	need to convert these to 16 bits
	can do it either in the renderer or in the viewer
		better do it in the renderer
		the viewer should contain as little logic as possible
		the renderer can at least be tested
	blitting in the renderer gets hairy, however
	it would be easier to do in the viewer
Graphin refactor
	HIMG and HGFX have to be factored out to avoid leaks
	or they just need scope guards
	we can also avoid including graphin.h the view
failing to upload a single note stops sync
	should persevere
	mark the failed note somehow
	TODO
storing db on the storage card
	need an option to move the db from device memory and back
	need to be able to locate it again
		we have a default location on the device
			My Documents\People's Note
		can replicate this on the storage card
		then look in both places
	the move would be done from the profile page
		the profile page would display
			username
			database location
			database size
			button to switch between device and storage card
		this is also relevant for the anonymous user
			what to call the menu item?
				"Profile"
			what is it called in Evernote?
				"Account properties"
				does not apply to the anonymous case
note update
	does not seem to update local resources
	testing shows that it downloads updated images
	the updated note is added, not updated, for some reason
	this is because updating is for locally modified notes
	resources do not need to be udpated in this case
do I need both Credentials and ICredentialsModel?
	TODO
how should LoadAs handle folder choice?
	should find where the database is located
		move it to the new name in the same folder
		load the new name
	what's the problem?
		seems like the search is done repeatedly
		it used to be done repeatedly before
		except with only one folder
	what about LoadOrCreate?
		should load from device first
		should only create if both folders are empty
	so, what to do if the flash card is missing?
		then attempts to create files there will fail
		simple
		wait
		where is "there"?
		would have to use some invalid path
			and hope that it stays invalid
		how about we abstract away the number of storage locations?
			created a class
			return locations in order of priority
			have UserModel check all locations in order
the icon is missing when installing on Samsung Blackjack II
	TODO
might not want to create the "People's Note" folder on the storate card needlessly
	ok
should not change the status of the "move" button unless the move succeeded
	can subscribe to the Load event
	but then, we want to know where the database is
		to set the state correctly
	this way, the button state would be in sinc with the path
	so, we ask the database where it is
	how does it answer?
	it could either
		check where it is
			- a little slow
		remember where it was stored
			- multiple code changes
	actually, since it has to be in sync...
	the answer should be retreived the same way as the path
		from the data store
	then this info should be remembered when data store is loaded
discovering the storage card at startup is a bad idea
	how should it be discovered?
	events and implications
		storage card added
			one more folder to search for database
			can move the database there
		storage card removed
			if the database was there, then quit
			else, we can no longer move it there
	lets write down the user stories
	requirements
		need discovery to disable the move-db button
			when the profile page is shown
			when the database is about to be moved
		need discovery whenever the database is opened
			also need the appropriate path
	solutions
		storage card path provider
			would be used by both profile presenter and user model
		standalone functions to check presence and to get the path
			- not mockable
	first choice it is, then
	API
		bool GetPath(wstring &)
	
transactions seem to fail on the storage card
	at the end
	although the changes are made
	SQLITE_IOERR_DELETE
	solved by setting exclusive open mode
	Heuston, we have a problem!
	exclusive open mode prevents opening 
	possible solutions
		avoid exclusive opening
			- may cause problems
		open the file only once
			- significant code changes
	lets see, whether lack of the flag causes problems on a real storage card
		does not look like it
		lets release without the pragma
should disable the database move button for the duration of operation
	done
should give checkboxes a wider right margin
	done
note list scrolling does not update after adding an ink note
	or any other kind of note...
	it might have to do with the note list view being a parent window
	WM_CLOSE is posted
		so scrolling is updated while note list view is still disabled
	UpdaetScrollbar returns early
		contentSize is zero
	looks like it was an HtmLayout bug
		fixed by updating to version 3.3.2.15
should maximize the note editor window when the toolbar is hidden
	can copy the resizing code from the note view window
	aside: interesting how similar these windows are becoming
	how to resize the editor view window
		4 states
			maximized, sip
				extended sipInfo.rcVisibleDesktop
			maximized, no sip
				CM_CXSCREEN x CM_CYSCREEN - menuBarRect
			restored, sip
				sipInfo.rcVisibleDesktop
			restored, no sip
				SPI_GETWORKAREA - menuBarRect
		so, basically
		get sipInfo.rcVisibleDesktop
		if isMaximized
			extend to the upper edge
		if no sip
			subtract menuBarRect
note thumbnails are not updated after sync
	could delete thumbnails for updated notes
	what happens is the new note is added
	not enough
	need to refresh the thumbnail image in note list view
	want to avoid caching all thumbnails
	can add a loop to SyncPresenter...
	TODO
default notebook changes are not synchronized
	what is missing?
	when note processor fetches a note, it should check defaultness
	but note store does not get that information
		no point in storing it in the note structure
		just add a boolean output parameter
	wait, what function am I talking about?
	default notebook can change without addition of new notebooks
	then it should be a separate function
		what is the API like?
			NoteStore::GetDefaultNotebook
	it is not a typical sync "action"
		so it should be in SyncModel::Sync
		a newly added notebook could be set the default
		but the old default could be deleted
		and since defaultness is not listed in the updates
			we must allow for default notebook deletion
			within the database
		default notebook should be set last
		what if there are no actions?
		should it still be set?
			sure, why not?
it looks like there is a problem with replaced ink notes
	generating a thumbnail
	can't find a resource
	offline client shows the note as a binary attachment
	offline client continues to show the correct thumbnail
	hypothesis
		sync changes hash
	lets check a new note
	no, the replacement always has the same body
	note deletions cascade to resources
other clients are not recognizing my image notes
	turns out, I had to set resource mime type
	but where do I get it from?
	have to store it in the database
need to update EnImporter tests
	done
is version checked in all load paths?
	no
	should move version checking into Update
		which is called in all load paths
add an option of forcing full synchronization
	TODO
photo settings
	need a model
	done
tag indexing
	how are tags stored, anyway?
		Notes, Tags, NoteTags
		a many-to-many relationship
	I recall there were some glitches with them
		displaying multiple copies of a tag
			seems fine...
			ah, there
			if a note is updated, tags are duplicated
				why does this happen?
				for every tag found in the note store
					find the corresponding guid
					add it to the note
				this means that NoteTags gets duplicate entries
				because the hidden id serves as the key
				should add a uniqueness constraint on the pairs
	to search for a tag
		get all Tags matching given name
			sequential search without an index
			and what is the "given name", anyway?
				could be a search word combination
				searching for all combinations would be a bad idea
			alternatively, search for each word
				then search the whole search term for the tag
			simpler, require entire search term to be in the tag
				that would be the "given name"
				migration is much more difficult this way, however
					since we can't add a UNIQUE column
		get all NoteTags for each tag
			again sequential search
		combine notes
	with full text search
		I could add tag names to the text title
			could I?
			how to update the field when either title or tags change?
			only be rebuilding it completely
			this would create O(N²) complexity for tag addition
				even assuming DB lookup is constant-time
		is there anything wrong with this?
			could I tell which part of the note matched?
				no...
				is this a problem?
				might be
		now, I add the tag field to the FTS table
		then add a migration
			I don't think I can migrate a virtual table...
			but lets try
			it can't be done
		lets abondon this idea
	SQL
		SELECT DISTINCT n.guid, n.usn, n.title, n.creationDate, n.isDirty
		FROM   Notes as n, NoteTags as nt, Tags as t
		WHERE  t.searchName = ? AND nt.tag = t.guid AND n.guid = nt.guid
	migration
		add a UNIQUE column with uppercase tag names
			rename the tags table
			get all the tags out of it
			create a new table with this column
			insert tags into the new table
		add an index for this table
		add an index for tag->note matching
cancelled photos
	need to make it more clear when a photo is cancelled
	done
photo dialog does not show up on square displays
	it does
	something else was wrong with that Trio 700wx
should add keyboard handling to the photo dialog
	fixed
a thumbnail gets opened in IE following full sync
	time to test this
	list-style-image is retrieved over http
	html data loader opens it in IE
		because it starts with http:
	how to address this problem?
		we want to be able to download images over http
		htmlayout has this ability
		but html data loader does not depend on htmlayout
			do I want to add this dependency?
				could try and see if tests pass
		returning NULL might work, actually
			lets try it
		seems to work
removal of tags from notes is not being seen
	how to fix this?
	need to remove old tags before adding the new
image search
	lets check the reference first
		import
			en-export > note > resource > recognition
			contains CDATA with custom XML
		sync
			NoteStore.getResource
				withRecognition parameter
				returns Data
					which a string with a hash
			NoteStore.getResourceRecognition
				return string
			both methods probably return XML
		custom XML format
			top recoIndex element
				rectangular regions — items@x,y,w,h
					reocgnized words with weights — t@w
	database
		need to store items with positions for each resource
			do I want a separate region table?
			I don't see why I would
			this would imply the need to search by region
			but I probably want to store weights
				just in case
	import integration
		we want a separate testable class handling recognition XML
		this class would be used by the importer
	implementation plan
		add a table to the database
		create the XML processing engine
		update integration
		update search
		update synchronization
	xml processign engine
		should extract the tags
		does it mean I need a separate structure for this?
		lets add it
	synchronization
		need to remove previous entries before updating a resource
		if resources are even updated
slow synchronization
	frequently times out
	looks like it was a connection problem
recognition parser failure
	missing "<" in some notes
	for some reason, the string ends with a "P"
		character count problem?
		maybe passing the data straight to ConvertToUnicode is a bad idea
		maybe it is not null-terminated
	null-terminating the data seems to have helped
db profiling
	need to time queries
		record the time of each query
			or just the statistics
		how to identify queries?
			they are all static strings
			so we could store a set of pointers
		report
			convert pointers to indices
				perhaps, use map, instead of set
			print out the queries
			print out the stats
	TODO
note deletion
	there seems to be no action for deletion of remote resources
	it is not in the spec, either
	so, we need an "expunged note" list
	a new table or a new column?
		column would make it easier to preserve resources
			there is no SQL command for moving row to another table
			it would not make sense for foreign constraints, anyway
			so recording deletion in a new table would not be reversible
				bad design choice
		organizing a trash bin would be equally easy either way
		listing notes is a little more difficult with a column
note scrolling
	lets recall the touch scrolling states
		idle
			mouse down, move beyond threshold → dragging
		animating
			mouse down → dragging
			velocity drops below threshold → idle
		dragging
			mouse up → animating
				set velocity
	HTMLayout recently added gestures support
		lets find out a little more about it
			support for
				zooming
				panning
				rotation
				one and two-finger taps
			inertia processor
				how to set inertia?
					GESTURE_FLAG_PAN_WITH_INERTIA
				looks like I have to actually set positions
					as before
				does not seem to be configurable
		multitouch gestures probably not for WM
		experiment
			lets try this on the notes window
			does not seem to work at all
		only works in Windows 7
	now I have to add gestures manually
		good opportunity to improve it in the note list, also
		what do I need?
			handle mouse events
			handle animation events
			handle state
	I really want to encapsulate touch scrolling
		what state does it have?
			ButtonDown message
			click coordinates
			starting scroll position
			drag speed
			drag acceleration
			click time
			state id
		what does it do?
			OnMouseDown
				stop animation
				save initial state
					time
					position
					message
			OnMouseMove
				scroll
			OnMouseUp
				test distance from MouseDown
				calculate drag speed
				start animation
			AnimateScroll
				scroll
				stop animation
		can create an animation class
			on MouseDown
				stop animation
				ask the class to save initial state
			OnMouseMove
				test distance from MouseDown
				scroll
			OnMouseUp
				start animation
				ask the class to start animation
			AnimateScroll
				scrolls by querying the class
				stops animation by querying the class
		so, this class is just for handling the math
		we could have different classes for different kinds of animation
		but then, each window would talk to its animation class in the same way
		this is what we really have to factor out
		so, how do we factor out message handling?
			can have the animation class filter messages and signal events
			it would be just a regular switch statement, then
			but it would not be a large one
			plus, no casting, because the WinMsg infrastructure could be used
		how to handle different gestures?
			don't want to repeat the logic in every gesture processor, either
				would have been the same as repeating it in every window
			what is the difference between the different gestures?
			lets see...
			what are the different gestures?
				vertical scrolling of the note list
					might want to implement vertical gutters
				2D scrolling of the note note display
					might want to implement vertical and horizontal gutters
				horizontal note dragging for deletion from the note list
					the note should slide back, if not dragged far enough
			differences
				note list
					different horizontal and vertical thresholds
					either horizontal or vertical animation, but not both
				note view
					circular threshold
					2D animation
			the animation itself would have to be performed by the window
			both of these gestures are panning gestures
			is it possible I might want rotation gestures, or such?
				conceivable, but unlikely
			then make a gesture class specialized for panning
				worry about refactoring later
				YAGNI
			how do I differentiate the two different animation styles?
				I probably should not
				they don't have all that much in common...
				or do they?
				they have the same mouse and animation handling logic
				that's quite a bit
			seems like inheritance is the answer here
				because the two styles have different parameters
				and because they have a few different functions
				they also signal different events
			can this be done without inheritance?
				each animation style has
					a constructor with different parameters
						that saves them
					a ProcessMessage function
						that calls the underlying base class
			hold on
			Stop the presses!
			very different animations here
				totally different states
				different mouse handling logic
				might be a good idea to simply make separate classes
		do I need an interface on the gesture processor?
			it is only used as a helper by the views
			views are not tested
			therefore, no interface is needed
		there is another issue
		how is the window involved, exactly?
			it acts on animation events, of course
			also determines when an animation begins
				filters mouse click messages before passing to gesture engine
		maybe the windows should pass all messages to the gesture engine
			then the engine would not need a switch statement
				and no casting
		seems like a good idea
			only 3 messages, right?
	how to handle delayed clicking?
		need to call process message at some point
		let the gesture processor handle it
			expose an event and a property
	who sets capture?
		main window
		it also decides whether to pass messages to the gesture processor
	how to determine starting scrolling position?
		signal animation start
		let the window save scrolling position
gesture improvement
	clicking is too hard right now
	fingertips create spurious messages, apparently
		first one part of the finger touches, then another
		what messages do I receive, exactly, in this case?
		lets log mouse messages
	analyzing the messages now
		clicks are 140-179 ms, 3-11 px
		drag is 150-350 ms, >22 px
	can't use time to differentiate dragging from clicking
	distances should be in physical units, by the way
		can limit this to just the threshold, for now
need to fix black photos
	looks like HTMLayout's fault
need to fix the photo editor's menu
	fixed
2D acceleration
	speed should be a vector now
	stopping condition should depend on L2 speed magnitude
	scroll distance should be computed componentwise
want to hide scrollbars when note view window is hidden
	done
too many notes get updated after changing default notebook
	lets begin with this dude
	debug on the device
	set breakpoint at note sync
	all remote notes are added
		lets see why
		both remote and local notes are present
		the local note is clean
		normal behavior
	why does it even scan that far back?
		notebookUpdateCount is 0
		it is zero in the database
		why is it zero?
	TODO
connections time out too early
	TODO
password stars can be the wrong colour
	maybe they are not the wrong colour
	maybe the user's font does not have the '•' symbol
	lets change it to '*'
moving db to storage card fails
	button becomes disabled, but nothing happens
	no error is displayed
	turned out to be a low-res layout error
local notes get lost after first synchronization
	this is indeed the case lets investigate
	fixed
adding note view menu
	the menu shows up on the note list view
	should have created it hidden
should remove unnecessary icons
	done
need to handle failed notes better when syncing
	if a note fails
		mark it as failed
			maybe better to mark dirty notes, instead
		log the error
			do I want to repeat all the exception handlers?
			there has to be a better way…
			so, I catch the exception, then what?
			can't use visitor pattern
				since hierarchy is not completely defined by me
		continue to other notes
		at the end
			notify the user of failure
				"Some notes could not be synchronized."
				requires a flag to be set?
				or else could count the number of notes not synced
			how to notify?
				NoteListPresenter handles this
				at the end, if some notes are left
					it should display a message
				but message display and dirty note counts are handled separately
				and independently of which state they are called from
				lets create a new function to do this
				or I could set status from the model
				that would be simpler
mark dirty notes
	need to mark a note after editing it
	should this be done by the database or by the presenters?
	presenters are better, because they are easier to test
		although, then there is no guarantee that every modification is marked
		but this might not even always be desirable
			such as when?
			such as when importing notes, perchaps
	how should unsynced notes look?
		maybe a little darker
			or a little lighter, less saturated
		will this interfere with any images?
		yes, the corner graphic
		lets draw another one
what happens at first sync, if the account contains notes from anonymous account
	same as usual
	local notes are uploaded
		but remote are not downloaded
	note that the Notes notebook is never duplicated
		so, if it exists on the client
			but not on the server
			is it deleted?
				only if clean
	oops
	when a notebook is uploaded
		we get its replacement
		then we delete the old notebook
			along with all the notes!
		then we add the replacement
	
	instead
		we should update the local notebook
have to set text colour
	phew… fixed
want to add stack support
	TODO
need to check local note deletion
	fixed
need to improve the message on wrong password
	done
should not store password in the database!
	TODO
note titles
	need to
		add a menu option
		to switch notebook title on or off
		notebook title would mirror the window title
	action plan
		add high-res markup
		add output
		test
		add menu logic
		test
		add low-res markup
